<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Lịch Sử Mua Hàng - Sport Shop</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <style>
    :root{
      --primary:#3498db;
      --primary-dark:#2980b9;
      --muted:#6c757d;
      --bg:#f6f8fb;
      --card:#ffffff;
      --border:#eaecef;
    }
    body{
      background:var(--bg);
      font-family: ui-sans-serif,system-ui,"Segoe UI",Roboto,Helvetica,Arial;
      padding:24px;
    }
    .page-title{
      color:var(--primary);
      font-weight:700;
      font-size:28px;
      text-align:center;
      margin:0 0 24px;
    }
    .nav-pills .nav-link{
      border-radius:999px;
      padding:.5rem 1rem;
      margin-right:.5rem;
      color:#334155;
      background:#eef2f7;
      border:1px solid var(--border);
      transition:.2s ease;
    }
    .nav-pills .nav-link:hover{ background:#e6edf5; }
    .nav-pills .nav-link.active{
      background:var(--primary);
      border-color:var(--primary);
      color:#fff;
      box-shadow:0 6px 14px rgba(52,152,219,.25);
    }
    .table{
      background:var(--card);
      border-radius:16px;
      overflow:hidden;
      box-shadow: 0 8px 20px rgba(0,0,0,.06);
    }
    thead.table-light{
      background:#f3f6fb !important;
      border-bottom:1px solid var(--border);
    }
    .table > :not(caption) > * > *{
      padding:14px 16px;
      vertical-align:middle;
    }
    .table-hover tbody tr:hover{ background:#fafcff; }
    .back-button{
      display:block; margin:24px auto 0; padding:12px 22px;
      background:var(--primary); color:#fff; border:none; border-radius:999px;
      text-decoration:none; width:fit-content; transition:.2s ease;
    }
    .back-button:hover{
      background:var(--primary-dark); color:#fff; text-decoration:none;
      transform:translateY(-1px); box-shadow:0 8px 18px rgba(41,128,185,.25);
    }
    .empty-row{ color:var(--muted); padding:32px 0 !important; }
  </style>
</head>
<body>
<div class="container" th:with="
  st=${status != null ? status : (param.status != null ? param.status[0] : 'Dang_Xu_Ly')}
">

  <div th:if="${message}" class="alert alert-success text-center" role="alert">
    <span th:text="${message}"></span>
  </div>

  <h1 class="page-title">
    <i class="fas fa-history me-2"></i> Lịch Sử Mua Hàng
  </h1>

  <!-- Status pills -->
  <ul class="nav nav-pills mb-3">
    <li class="nav-item">
      <a class="nav-link"
         th:classappend="${st}=='Dang_Xu_Ly' ? ' active'"
         th:href="@{/user/history(status='Dang_Xu_Ly')}">
        Đang xử lý
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link"
         th:classappend="${st}=='Dang_Giao' ? ' active'"
         th:href="@{/user/history(status='Dang_Giao')}">
        Đang giao
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link"
         th:classappend="${st}=='Da_Giao' ? ' active'"
         th:href="@{/user/history(status='Da_Giao')}">
        Đã giao
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link"
         th:classappend="${st}=='Da_Huy' ? ' active'"
         th:href="@{/user/history(status='Da_Huy')}">
        Đã hủy
      </a>
    </li>
  </ul>

  <!-- Orders table -->
  <table class="table table-striped table-hover align-middle">
    <thead class="table-light">
    <tr>
      <th style="width:10%">Mã đơn</th>
      <th style="width:16%">Ngày đặt</th>
      <th>Tên sản phẩm</th>
      <th class="text-center" style="width:10%">Số lượng</th>
      <th class="text-end" style="width:14%">Giá</th>
      <th class="text-end" style="width:14%">Thành tiền</th>
      <th class="text-center" style="width:20%">Hành động</th>
    </tr>
    </thead>
    <tbody>
    <tr th:if="${#lists.isEmpty(rows)}">
      <td colspan="7" class="text-center empty-row">Không có đơn hàng ở trạng thái này</td>
    </tr>

    <tr th:each="r : ${rows}">
      <td>#<span th:text="${r.orderId}">1</span></td>
      <td th:text="${#dates.format(r.orderDate, 'dd/MM/yyyy HH:mm')}">01/08/2025 09:12</td>
      <td th:text="${r.productName}">Tên sản phẩm</td>
      <td class="text-center" th:text="${r.quantity}">1</td>
      <td class="text-end" th:text="|${#numbers.formatInteger(r.price, 0)} VNĐ|">0 VNĐ</td>
      <td class="text-end" th:text="|${#numbers.formatInteger(r.total, 0)} VNĐ|">0 VNĐ</td>
      <td class="text-center">
        <div class="d-flex justify-content-center gap-2">
          <!-- Nút xem chi tiết -->
          <a class="btn btn-sm btn-outline-primary"
             th:href="@{/user/history/{id}(id=${r.orderId})}">
            Xem chi tiết
          </a>

          <!-- Nút Hủy: chỉ khi Đang xử lý -->
          <form th:if="${st} == 'Dang_Xu_Ly'"
                th:action="@{/user/history/cancel}" method="post" style="display:inline"
                th:onsubmit="'return confirm(\'Hủy đơn #'+${r.orderId}+'?\')'">
            <input type="hidden" name="orderId" th:value="${r.orderId}"/>
            <input th:if="${_csrf != null}" type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <button type="submit" class="btn btn-sm btn-outline-danger ms-1">Hủy</button>
          </form>

          <!-- Nút Đánh giá: chỉ khi ĐÃ GIAO -->
          <button th:if="${st} == 'Da_Giao'"
                  type="button"
                  class="btn btn-sm btn-outline-success"
                  data-bs-toggle="modal"
                  data-bs-target="#reviewModal"
                  th:attr="data-product-id=${r.productId}, data-product-name=${r.productName}">
            Đánh giá
          </button>

          <!-- Nút Hoàn hàng: chỉ khi ĐÃ GIAO -->
          <form th:if="${st} == 'Da_Giao'"
                th:action="@{/user/orders/return}" method="post" style="display:inline"
                th:onsubmit="'return confirm(\'Hoàn hàng đơn #'+${r.orderId}+'?\')'">
            <input type="hidden" name="orderId" th:value="${r.orderId}"/>
            <input th:if="${_csrf != null}" type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <button type="submit" class="btn btn-sm btn-outline-warning">Hoàn hàng</button>
          </form>
        </div>
      </td>
    </tr>
    </tbody>
  </table>

  <a href="/home" class="back-button">
    <i class="fas fa-arrow-left me-2"></i> Quay lại trang chủ
  </a>
</div>

<!-- Modal Đánh giá -->
<div class="modal fade" id="reviewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <form th:action="@{/user/comments}" method="post" enctype="multipart/form-data">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fa-solid fa-star-half-stroke me-2"></i> Đánh giá sản phẩm
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
        </div>

        <div class="modal-body">
          <input type="hidden" name="productId" />
          <!-- CSRF -->
          <input th:if="${_csrf != null}" type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

          <!-- Tên sản phẩm -->
          <div class="mb-3">
            <label class="form-label">Sản phẩm</label>
            <input type="text" class="form-control" data-field="productName" readonly>
          </div>

          <!-- Chấm sao -->
          <div class="mb-3">
            <label class="form-label d-block">Đánh giá</label>
            <div class="rating d-inline-flex flex-row-reverse">
              <input type="radio" id="star5" name="rate" value="5"/><label for="star5" title="Tuyệt vời">★</label>
              <input type="radio" id="star4" name="rate" value="4"/><label for="star4" title="Tốt">★</label>
              <input type="radio" id="star3" name="rate" value="3"/><label for="star3" title="Khá">★</label>
              <input type="radio" id="star2" name="rate" value="2"/><label for="star2" title="Trung bình">★</label>
              <input type="radio" id="star1" name="rate" value="1" checked/><label for="star1" title="Kém">★</label>
            </div>
            <style>
              .rating input{ display:none; }
              .rating label{ font-size:28px; cursor:pointer; padding:0 4px; color:#ddd; transition:.15s; }
              .rating input:checked ~ label, .rating label:hover, .rating label:hover ~ label{ color:#f5c518; }
            </style>
          </div>

          <!-- Nội dung -->
          <div class="mb-3">
            <label class="form-label">Nội dung đánh giá</label>
            <textarea class="form-control" name="messages" rows="4"
                      placeholder="Chia sẻ trải nghiệm của bạn..." required></textarea>
          </div>

          <!-- Ảnh/Video -->
          <div class="mb-2">
            <label class="form-label">Ảnh/Video minh họa (tùy chọn)</label>
            <input class="form-control" type="file" name="media" multiple accept="image/*,video/*">
            <div class="form-text">Có thể chọn nhiều file. Hỗ trợ ảnh & video.</div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Quay lại</button>
          <button type="submit" class="btn btn-primary">Hoàn thành</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const reviewModalEl = document.getElementById('reviewModal');
  if (reviewModalEl) {
    reviewModalEl.addEventListener('show.bs.modal', function (evt) {
      const btn = evt.relatedTarget;
      const productId = btn.getAttribute('data-product-id');
      const productName = btn.getAttribute('data-product-name');

      const form = reviewModalEl.querySelector('form');
      // reset input (không reset CSRF)
      form.querySelector('textarea[name="messages"]').value = '';
      const filesInput = form.querySelector('input[name="media"]');
      if (filesInput) filesInput.value = '';
      // mặc định 5 sao (nếu muốn)
      const star5 = form.querySelector('#star5');
      if (star5) star5.checked = true;

      form.querySelector('input[name="productId"]').value = productId;
      reviewModalEl.querySelector('[data-field="productName"]').value = productName;
    });
  }
</script>

</body>
</html>
